<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Resultados de Pruebas | Tema Híbrido Mejorado</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto+Mono&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --primary-color: #22c55e;
      /* verde matriz → títulos y botón */
      --secondary-color: #0f172a;
      --accent-color: #06b6d4;
      /* cian brillante → subtítulos */
      --background-color: #0a0a0a;
      --text-color: #e2e8f0;
      --text-muted: #94a3b8;
      --border-color: #1e293b;
      --card-shadow: 0 0 25px rgba(34, 197, 94, 0.15);
      --border-radius: 12px;

      --chart-bg-color: #1e2937;
      --chart-grid-color: #374151;
      --chart-text-color: #d1d5db;
      --chart-primary-color: #06b6d4;
      /* 🔹 gráficos solo en cian */
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 30px;
      background: var(--background-color);
      color: var(--text-color);
    }

    h1 {
      text-align: center;
      font-family: 'Roboto Mono', monospace;
      font-size: 2.8em;
      font-weight: 600;
      color: var(--primary-color);
      /* verde */
      text-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
    }

    .container {
      max-width: 1200px;
      margin: auto;
    }

    .resumen-pruebas {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin: 20px 0;
      padding: 15px;
      background: rgba(30, 41, 55, 0.6);
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(6, 182, 212, 0.3);
    }

    .resumen-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 8px;
      font-family: 'Roboto Mono', monospace;
      font-size: 14px;
      font-weight: bold;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #1e293b;
    }

    .resumen-item.success {
      color: #10b981;
      /* verde */
      border-color: #10b981;
    }

    .resumen-item.fail {
      color: #ef4444;
      /* rojo */
      border-color: #ef4444;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border: 1px solid #06b6d4;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 0 15px rgba(6, 182, 212, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 0 20px rgba(6, 182, 212, 0.4);
    }

    .stat-label {
      font-size: 14px;
      color: #94a3b8;
      font-weight: 500;
    }

    .stat-value {
      font-size: 18px;
      font-weight: bold;
      margin-top: 6px;
      color: #06b6d4;
      text-shadow: 0 0 5px rgba(6, 182, 212, 0.5);
    }

    /* 🔹 Scroll minimalista para la moda */
    .moda-scroll {
      max-height: 60px;
      /* límite vertical */
      overflow-y: auto;
      /* scroll vertical si es necesario */
      overflow-x: hidden;
      margin-top: 6px;
      padding-right: 6px;
      scrollbar-width: thin;
      scrollbar-color: #06b6d4 #1e293b;
    }

    /* Para navegadores Webkit */
    .moda-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .moda-scroll::-webkit-scrollbar-track {
      background: #1e293b;
      border-radius: 6px;
    }

    .moda-scroll::-webkit-scrollbar-thumb {
      background-color: #06b6d4;
      border-radius: 6px;
    }

    .moda-item {
      font-size: 14px;
      color: #06b6d4;
      display: inline-block;
      margin: 2px 4px;
      padding: 2px 6px;
      border-radius: 6px;
      background: rgba(6, 182, 212, 0.1);
      white-space: nowrap;
    }

    .pruebas-grid {
      display: grid;
      grid-template-columns: 1fr;
      /* siempre una columna */
      gap: 25px;
      margin-top: 30px;
    }


    .prueba-card {
      background: var(--secondary-color);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--card-shadow);
      transition: transform 0.3s ease;
    }

    .prueba-card:hover {
      transform: translateY(-5px);
    }

    .prueba-card h2 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 20px;
      font-family: 'Roboto Mono', monospace;
      color: var(--accent-color);
      /* cian brillante */
    }

    .prueba-card p {
      font-family: 'Roboto Mono', monospace;
      color: var(--text-muted);
      background: #020617;
      padding: 10px;
      border-radius: 6px;
      word-wrap: break-word;
      font-size: 14px;
    }

    .chart-container {
      position: relative;
      margin-top: 15px;
      padding: 15px;
      background: var(--chart-bg-color);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    canvas {
      width: 100% !important;
      height: 280px !important;
    }

    .export-btn {
      margin-top: 15px;
      padding: 8px 16px;
      background: transparent;
      color: var(--primary-color);
      /* verde */
      border: 1px solid var(--primary-color);
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .export-btn:hover {
      background: var(--primary-color);
      /* verde */
      color: var(--background-color);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
    }

    .stats-info {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
      font-family: 'Roboto Mono', monospace;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Resultados de las Pruebas</h1>

    <div id="resumenPruebas" class="resumen-pruebas"></div>


    <div class="pruebas-grid" id="pruebasResultados">
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>


  <script>
    let charts = [];

    const resultados = JSON.parse(sessionStorage.getItem("resultadosPruebas"));

    let nums = [];

    fetch('/all')
      .then(response => response.json())
      .then(data => {
        nums = data;
        renderResultados();
        renderResumenPruebas(resultados);
        renderEstadisticos(nums);
      })
      .catch(error => {
        console.error('Error al obtener los números:', error);
      });

    const temaHibrido = {
      backgroundColor: 'rgba(30, 41, 55, 0.8)',
      gridColor: 'rgba(55, 65, 81, 0.6)',
      textColor: '#d1d5db',
      chartColor: '#06b6d4', // siempre cian para las gráficas
      successColor: '#10b981', // verde para valores dentro del rango
      warningColor: '#f59e0b', // amarillo para valores límite
      errorColor: '#ef4444'    // rojo para valores fuera del rango
    };

    console.log("Resultados de Pruebas:", resultados);

    function renderResumenPruebas(resultados) {
      const contenedor = document.getElementById("resumenPruebas");
      contenedor.innerHTML = "";

      const orden = [
        "Prueba de Medias",
        "Prueba de Varianza",
        "Prueba Chi-Cuadrado",
        "Prueba KS",
        "Prueba de Poker",
        "Prueba de Rachas"
      ];

      orden.forEach(nombre => {
        const prueba = Object.values(resultados)
          .map(r => JSON.parse(r))
          .find(p => p.test_name === nombre);

        if (prueba) {
          const aprobado = prueba.isApproved === "True";
          const div = document.createElement("div");
          div.className = `resumen-item ${aprobado ? "success" : "fail"}`;
          div.innerHTML = aprobado
            ? `✅ ${nombre}`
            : `❌ ${nombre}`;
          contenedor.appendChild(div);
        }
      });
    }

    function calcularEstadisticos(nums) {
      if (!nums || nums.length === 0) {
        return { media: 0, mediana: 0, modas: [], max: 0, min: 0, rango: 0, maxFrecuencia: 0 };
      }

      const n = nums.length;

      // 🔹 Media (una sola pasada)
      let suma = 0;
      let max = -Infinity;
      let min = Infinity;

      // 🔹 Frecuencias
      const freq = new Map();
      let maxFrecuencia = 0;

      for (let v of nums) {
        suma += v;
        if (v > max) max = v;
        if (v < min) min = v;

        const f = (freq.get(v) || 0) + 1;
        freq.set(v, f);

        if (f > maxFrecuencia) {
          maxFrecuencia = f;
        }
      }

      const media = suma / n;

      // 🔹 Mediana (ordenar es inevitable si la necesitas exacta)
      const ordenados = [...nums].sort((a, b) => a - b);
      const mitad = Math.floor(n / 2);
      const mediana = (n % 2 !== 0) ? ordenados[mitad] : (ordenados[mitad - 1] + ordenados[mitad]) / 2;

      // 🔹 Obtener solo las modas (máxima frecuencia)
      let modas = [];
      if (maxFrecuencia > 1) {
        for (const [valor, f] of freq.entries()) {
          if (f === maxFrecuencia) {
            modas.push({ valor: Number(valor), frecuencia: f });
          }
        }
        modas.sort((a, b) => a.valor - b.valor);
      }

      const rango = max - min;

      return { media, mediana, modas, max, min, rango, maxFrecuencia };
    }

    function renderEstadisticos(nums) {
      const stats = calcularEstadisticos(nums);

      let modasHtml = "";
      if (stats.maxFrecuencia <= 1) {
        modasHtml = `<div class="stat-value" style="font-size:14px; color:#94a3b8;">Todos son diferentes (no hay moda)</div>`;
      } else {
        // 🔹 Límite de visualización para eficiencia
        const limite = 50;
        const total = stats.modas.length;
        const mostrar = stats.modas.slice(0, limite);

        modasHtml = `<div class="moda-scroll">` +
          mostrar.map(m => `<span class="moda-item">${m.valor} (${m.frecuencia})</span>`).join("") +
          (total > limite ? `<span class="moda-item">+${total - limite} más</span>` : "") +
          `</div>`;
      }

      const contenedor = document.createElement("div");
      contenedor.className = "stats-grid";
      contenedor.innerHTML = `
      <div class="stat-card">
        <div class="stat-label">Media</div>
        <div class="stat-value">${stats.media.toFixed(5)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Mediana</div>
        <div class="stat-value">${stats.mediana.toFixed(5)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Moda</div>
        ${modasHtml}
      </div>
      <div class="stat-card">
        <div class="stat-label">Máximo</div>
        <div class="stat-value">${stats.max.toFixed(5)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Mínimo</div>
        <div class="stat-value">${stats.min.toFixed(5)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Rango</div>
        <div class="stat-value">${stats.rango.toFixed(5)}</div>
      </div>
    `;

      const resumenDiv = document.getElementById("resumenPruebas");
      const existing = resumenDiv.nextElementSibling;
      if (existing && existing.classList.contains('stats-grid')) {
        existing.replaceWith(contenedor);
      } else {
        resumenDiv.insertAdjacentElement("afterend", contenedor);
      }
    }

    function obtenerConfiguracionMedias(prueba) {
      // 🔹 límite máximo de puntos a graficar
      const maxPoints = 2000;
      const step = Math.max(1, Math.ceil(nums.length / maxPoints));

      // 🔹 construir arreglo de puntos con muestreo
      const datos = nums
        .map((valor, i) => ({
          x: i + 1,
          y: valor,
          enRango: valor >= prueba.limite_inferior && valor <= prueba.limite_superior
        }))
        .filter((_, i) => i % step === 0); // muestreo automático

      const dentro = datos.filter(d => d.enRango);
      const fuera = datos.filter(d => !d.enRango);

      return {
        type: 'scatter',
        data: {
          datasets: [
            {
              label: `En rango [${prueba.limite_inferior.toFixed(2)}, ${prueba.limite_superior.toFixed(2)}]`,
              data: dentro.map(d => ({ x: d.x, y: d.y })),
              backgroundColor: 'red',
              pointRadius: nums.length > 5000 ? 2 : 5 // puntos más chicos si hay muchos
            },
            {
              label: 'Fuera del rango',
              data: fuera.map(d => ({ x: d.x, y: d.y })),
              backgroundColor: 'gray',
              pointRadius: nums.length > 5000 ? 2 : 5
            },
            {
              label: `Límite inferior = ${prueba.limite_inferior.toFixed(3)}`,
              data: [
                { x: 0, y: prueba.limite_inferior },
                { x: prueba.n, y: prueba.limite_inferior }
              ],
              borderColor: 'blue',
              borderDash: [6, 4],
              borderWidth: 2,
              showLine: true,
              fill: false,
              pointRadius: 0
            },
            {
              label: `Límite superior = ${prueba.limite_superior.toFixed(3)}`,
              data: [
                { x: 0, y: prueba.limite_superior },
                { x: prueba.n, y: prueba.limite_superior }
              ],
              borderColor: 'blue',
              borderDash: [6, 4],
              borderWidth: 2,
              showLine: true,
              fill: false,
              pointRadius: 0
            },
            {
              label: `Media muestral = ${prueba.media_muestra.toFixed(3)}`,
              data: [
                { x: 0, y: prueba.media_muestra },
                { x: prueba.n, y: prueba.media_muestra }
              ],
              borderColor: '#f59e0b',
              borderWidth: 2,
              borderDash: [4, 2],
              showLine: true,
              fill: false,
              pointRadius: 0
            },
            {
              label: `Media teórica = ${prueba.mu_esperada.toFixed(3)}`,
              data: [
                { x: 0, y: prueba.mu_esperada },
                { x: prueba.n, y: prueba.mu_esperada }
              ],
              borderColor: '#10b981',
              borderWidth: 2,
              borderDash: [4, 4],
              showLine: true,
              fill: false,
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: temaHibrido.textColor,
                usePointStyle: true
              }
            },
            title: {
              display: true,
              text: `Valores Ri y rango de aceptación (n=${prueba.n}, graficados ${datos.length})`,
              color: temaHibrido.textColor,
              font: { size: 16, weight: 'bold' }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Índice de muestra',
                color: temaHibrido.textColor
              },
              grid: { color: temaHibrido.gridColor },
              ticks: { color: temaHibrido.textColor }
            },
            y: {
              min: 0,
              max: 1,
              title: {
                display: true,
                text: 'Ri',
                color: temaHibrido.textColor
              },
              grid: { color: temaHibrido.gridColor },
              ticks: { color: temaHibrido.textColor }
            }
          }
        }
      };
    }



    // Configuración para la prueba de Kolmogorov-Smirnov
    function obtenerConfiguracionKolmogorov(prueba) {
      // Extraer datos de los intervalos
      const etiquetas = prueba.intervals_data.map(intervalo =>
        `[${intervalo.Inicial.toFixed(3)}, ${intervalo.Final.toFixed(3)})`
      );

      const probabilidadesObtenidas = prueba.intervals_data.map(intervalo => intervalo.P_Obt);
      const probabilidadesEsperadas = prueba.intervals_data.map(intervalo => intervalo.P_Esp_A);

      return {
        type: 'bar',
        data: {
          labels: etiquetas,
          datasets: [
            {
              label: 'Probabilidad Esperada Acumulada',
              data: probabilidadesEsperadas,
              backgroundColor: 'rgba(6, 182, 212, 0.7)',
              borderColor: '#06b6d4',
              borderWidth: 2,
              order: 2
            },
            {
              label: 'Probabilidad Obtenida Acumulada',
              data: probabilidadesObtenidas,
              backgroundColor: 'rgba(16, 185, 129, 0.7)',
              borderColor: '#10b981',
              borderWidth: 2,
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              labels: {
                color: temaHibrido.textColor,
                usePointStyle: true
              }
            },
            title: {
              display: true,
              text: `Prueba Kolmogorov-Smirnov - D_máx = ${prueba.statistics.max_difference.toFixed(5)} (Crítico: ${prueba.statistics.critical_value.toFixed(5)})`,
              color: temaHibrido.textColor,
              font: { size: 16, weight: 'bold' }
            },
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(30, 41, 55, 0.9)',
              titleColor: temaHibrido.textColor,
              bodyColor: temaHibrido.textColor,
              borderColor: temaHibrido.chartColor,
              borderWidth: 1,
              callbacks: {
                title: function (context) {
                  return `Intervalo: ${context[0].label}`;
                },
                label: function (context) {
                  const datasetLabel = context.dataset.label;
                  const value = context.parsed.y;
                  return `${datasetLabel}: ${value.toFixed(4)}`;
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Intervalos',
                color: temaHibrido.textColor,
                font: { size: 14 }
              },
              grid: { color: temaHibrido.gridColor },
              ticks: {
                color: temaHibrido.textColor,
                maxRotation: 45,
                font: { size: 10 }
              }
            },
            y: {
              title: {
                display: true,
                text: 'Probabilidad Acumulada',
                color: temaHibrido.textColor,
                font: { size: 14 }
              },
              grid: { color: temaHibrido.gridColor },
              ticks: {
                color: temaHibrido.textColor,
                callback: function (value) {
                  return value.toFixed(2);
                }
              },
              min: 0,
              max: 1.1
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          hover: {
            mode: 'index',
            intersect: false
          }
        }
      };
    }

    function obtenerConfiguracionVarianza(prueba) {
      const gl = prueba.n - 1; // grados de libertad
      const datosChiCuadrado = generarDistribucionChiCuadrado(gl);

      // Filtrar el área entre límites
      const datosArea = datosChiCuadrado.filter(p =>
        p.x >= prueba.Xi1 && p.x <= prueba.Xi2
      );

      // Completar el área (cerrando hacia el eje x)
      const areaCompleta = [
        { x: prueba.Xi1, y: 0 },
        ...datosArea,
        { x: prueba.Xi2, y: 0 }
      ];

      // Calcular valor χ²
      const chi2calc = prueba.chi2;

      return {
        type: 'line',
        data: {
          datasets: [
            {
              label: 'Distribución χ² teórica',
              data: datosChiCuadrado,
              borderColor: temaHibrido.chartColor,
              backgroundColor: 'transparent',
              fill: false,
              tension: 0.4,
              pointRadius: 0,
              borderWidth: 3
            },
            {
              label: 'Región de aceptación',
              data: areaCompleta,
              borderColor: 'transparent',
              backgroundColor: 'rgba(16, 185, 129, 0.3)', // verde transparente
              fill: true,
              pointRadius: 0,
              tension: 0.4
            },
            {
              label: `χ² calculado = ${chi2calc.toFixed(3)}`,
              data: [
                { x: chi2calc, y: 0 },
                { x: chi2calc, y: Math.max(...datosChiCuadrado.map(d => d.y)) }
              ],
              borderColor: temaHibrido.errorColor,
              borderWidth: 2,
              borderDash: [6, 4], // línea punteada
              pointRadius: 0,
              showLine: true,
              fill: false
            },
            {
              label: `LI = ${prueba.Xi1.toFixed(3)}`,
              data: [
                { x: prueba.Xi1, y: 0 },
                { x: prueba.Xi1, y: Math.max(...datosChiCuadrado.map(d => d.y)) }
              ],
              borderColor: temaHibrido.warningColor,
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              showLine: true,
              fill: false
            },
            {
              label: `LS = ${prueba.Xi2.toFixed(3)}`,
              data: [
                { x: prueba.Xi2, y: 0 },
                { x: prueba.Xi2, y: Math.max(...datosChiCuadrado.map(d => d.y)) }
              ],
              borderColor: temaHibrido.warningColor,
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              showLine: true,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: { enabled: false },
            legend: { labels: { color: temaHibrido.textColor } },
            title: {
              display: true,
              text: `Prueba de Varianza: σ² = ${prueba.varianza_muestral.toFixed(
                4
              )} (gl = ${gl})`,
              color: temaHibrido.textColor,
              font: { size: 14 }
            }
          },
          scales: {
            x: {
              type: 'linear',
              title: { display: true, text: 'Valor χ²', color: temaHibrido.textColor },
              grid: { color: temaHibrido.gridColor },
              ticks: { color: temaHibrido.textColor }
            },
            y: {
              title: { display: true, text: 'Densidad de Probabilidad', color: temaHibrido.textColor },
              grid: { color: temaHibrido.gridColor },
              ticks: { color: temaHibrido.textColor }
            }
          }
        }
      };
    }

    // Generar distribución Chi-cuadrado con jStat
    function generarDistribucionChiCuadrado(gl, puntos = 200) {
      const datos = [];
      const min = Math.max(0, gl - 5 * Math.sqrt(2 * gl)); // límite inferior aproximado
      const max = gl + 5 * Math.sqrt(2 * gl); // límite superior aproximado
      const paso = (max - min) / puntos;

      for (let i = min; i <= max; i += paso) {
        const y = jStat.chisquare.pdf(i, gl); // usamos jStat directamente
        datos.push({ x: i, y: y });
      }

      return datos;
    }


    function obtenerConfiguracionChiCuadrado(prueba) {
      const etiquetas = prueba.intervals_data.map(intervalo =>
        `[${intervalo.inicio.toFixed(3)}, ${intervalo.fin.toFixed(3)})`
      );

      const frecuenciasObservadas = prueba.intervals_data.map(intervalo => intervalo.frecuencia_obt);
      const n = prueba.n;
      const k = prueba.intervals;
      const frecuenciaEsperada = n / k;

      return {
        type: 'bar',
        data: {
          labels: etiquetas,
          datasets: [
            {
              label: 'Frecuencia Observada',
              data: frecuenciasObservadas,
              backgroundColor: 'rgba(6, 182, 212, 0.7)',
              borderColor: '#06b6d4',
              borderWidth: 1
            },
            {
              label: `Frecuencia Esperada (${frecuenciaEsperada.toFixed(2)})`,
              data: Array(etiquetas.length).fill(frecuenciaEsperada),
              type: 'line',
              borderColor: '#ef4444',
              borderWidth: 2,
              borderDash: [6, 4],
              fill: false,
              pointRadius: 0,
              tension: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              labels: { color: temaHibrido.textColor }
            },
            title: {
              display: true,
              text: `Prueba Chi-Cuadrado - χ² = ${prueba.statistics.chi2_total.toFixed(3)} (Crítico: ${prueba.statistics.chi2_critico.toFixed(3)})`,
              color: temaHibrido.textColor,
              font: { size: 16, weight: 'bold' }
            },
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(30, 41, 55, 0.9)',
              titleColor: temaHibrido.textColor,
              bodyColor: temaHibrido.textColor,
              borderColor: temaHibrido.chartColor,
              borderWidth: 1
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Intervalos',
                color: temaHibrido.textColor
              },
              grid: { color: temaHibrido.gridColor },
              ticks: { color: temaHibrido.textColor }
            },
            y: {
              title: {
                display: true,
                text: 'Frecuencia',
                color: temaHibrido.textColor
              },
              grid: { color: temaHibrido.gridColor },
              ticks: { color: temaHibrido.textColor }
            }
          }
        }
      };
    }

    // Configuración para la Prueba de Rachas con muestreo automático
    function obtenerConfiguracionRachas(prueba) {
      const n = prueba.Total;                 // número total de observaciones
      const esperadas = prueba.UR;
      const varianza = prueba.Varianza;
      const desv = Math.sqrt(varianza);

      // 🔹 Límite máximo de puntos a graficar
      const maxPoints = 2000;
      const step = Math.max(1, Math.ceil(n / maxPoints));

      // Función auxiliar para reducir datos
      function reducirDatos(generator) {
        const datos = [];
        for (let i = 1; i <= n; i += step) {
          datos.push(generator(i));
        }
        // asegurar que el último punto siempre aparezca
        if (datos[datos.length - 1].x !== n) {
          datos.push(generator(n));
        }
        return datos;
      }

      // Construcción de datasets
      const datosObservados = reducirDatos(i => ({
        x: i,
        y: (prueba.Rachas / n) * i
      }));

      const datosEsperados = reducirDatos(i => ({
        x: i,
        y: (esperadas / n) * i
      }));

      const datosSup = reducirDatos(i => {
        const media = (esperadas / n) * i;
        const margen = 1.96 * (desv / Math.sqrt(n)) * (i / n);
        return { x: i, y: media + margen };
      });

      const datosInf = reducirDatos(i => {
        const media = (esperadas / n) * i;
        const margen = 1.96 * (desv / Math.sqrt(n)) * (i / n);
        return { x: i, y: media - margen };
      });

      return {
        type: 'line',
        data: {
          datasets: [
            {
              label: 'Rachas acumuladas (observadas)',
              data: datosObservados,
              borderColor: 'rgba(6, 182, 212, 0.9)',   // azul/cian con un poco de transparencia
              backgroundColor: 'rgba(6, 182, 212, 0.5)', // relleno de puntos (si hay pocos datos)
              borderWidth: 3,                           // más gruesa para destacarse
              borderDash: [4, 2],                       // 🔹 punteada para diferenciar
              fill: false,
              tension: 0,
              pointRadius: n <= 200 ? 3 : 0,            // solo puntos si la muestra es pequeña
              order: 2                                  // siempre encima de la esperada
            },
            {
              label: 'Rachas esperadas',
              data: datosEsperados,
              borderColor: '#ef4444',
              borderDash: [6, 4],
              fill: false,
              borderWidth: 2,
              tension: 0,
              pointRadius: 0
            },
            {
              label: 'Intervalo de confianza 95%',
              data: [...datosSup, ...datosInf.reverse()],
              backgroundColor: 'rgba(148, 163, 184, 0.4)',
              borderColor: 'transparent',
              fill: true,
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: temaHibrido.textColor,
                usePointStyle: true
              }
            },
            title: {
              display: true,
              text: `Evolución de las Rachas (n=${n})`,
              color: temaHibrido.textColor,
              font: { size: 16, weight: 'bold' }
            }
          },
          scales: {
            x: {
              type: 'linear',
              title: {
                display: true,
                text: 'Número de observaciones',
                color: temaHibrido.textColor
              },
              grid: { color: temaHibrido.gridColor },
              ticks: { color: temaHibrido.textColor }
            },
            y: {
              title: {
                display: true,
                text: 'Rachas acumuladas',
                color: temaHibrido.textColor
              },
              grid: { color: temaHibrido.gridColor },
              ticks: { color: temaHibrido.textColor }
            }
          }
        }
      };
    }



    // Función principal para obtener configuración según el tipo de prueba
    function obtenerConfiguracionGrafico(prueba) {
      switch (prueba.test_name) {
        case "Prueba de Medias":
          return obtenerConfiguracionMedias(prueba);
        case "Prueba KS":
          return obtenerConfiguracionKolmogorov(prueba);
        case "Prueba de Varianza":
          return obtenerConfiguracionVarianza(prueba);
        case "Prueba Chi-Cuadrado":
          return obtenerConfiguracionChiCuadrado(prueba);
        case "Prueba de Rachas":
          return obtenerConfiguracionRachas(prueba);
        default:
          return null;
      }
    }


    function renderResultados() {

      renderResumenPruebas(resultados);

      const contenedor = document.getElementById("pruebasResultados");
      contenedor.innerHTML = '';
      charts = [];

      Object.keys(resultados).forEach(pruebaKey => {
        const prueba = JSON.parse(resultados[pruebaKey]);
        const card = document.createElement("div");
        card.className = "prueba-card";

        const title = document.createElement("h2");
        title.textContent = `${prueba.test_name}`;
        card.appendChild(title);

        const resumen = document.createElement("p");
        resumen.textContent = "→ " + prueba.decision;
        resumen.style.color = prueba.decision.includes("Pasa") ||
          prueba.decision.includes("No se rechaza") ?
          temaHibrido.successColor : temaHibrido.errorColor;
        card.appendChild(resumen);

        let chartContainer = null;
        let canvas = null;

        if (prueba.test_name !== "Prueba de Poker") {
          chartContainer = document.createElement("div");
          chartContainer.className = "chart-container";
          chartContainer.style.height = "400px";

          canvas = document.createElement("canvas");
          chartContainer.appendChild(canvas);
          card.appendChild(chartContainer);
        }


        // Agregar información estadística detallada
        const stats = document.createElement("div");
        stats.className = "stats-info";

        if (prueba.test_name === "Prueba de Medias") {
          stats.innerHTML = `
        <div class="stat-item"><strong>n:</strong> ${prueba.n}</div>
        <div class="stat-item"><strong>Media esperada (μ₀):</strong> ${prueba.mu_esperada}</div>
        <div class="stat-item"><strong>Media muestral (x̄):</strong> ${prueba.media_muestra.toFixed(5)}</div>
        <div class="stat-item"><strong>Estadístico Z:</strong> ${prueba.z.toFixed(5)}</div>
        <div class="stat-item"><strong>Intervalo de confianza:</strong> [${prueba.limite_inferior.toFixed(5)}, ${prueba.limite_superior.toFixed(5)}]</div>
      `;
        } else if (prueba.test_name === "Prueba KS") {
          stats.innerHTML = ""; // limpiar

          const tabla = document.createElement("table");
          tabla.style.width = "100%";
          tabla.style.borderCollapse = "collapse";
          tabla.style.marginTop = "10px";
          tabla.style.fontFamily = "'Roboto Mono', monospace";
          tabla.style.fontSize = "13px";
          tabla.style.color = "#e2e8f0";

          // Encabezados
          const encabezados = [
            "No", "Inicial", "Final",
            "Frec.Obt", "F.Obt.A", "P.Obt",
            "F.Esp.A", "P.Esp.A", "Dif"
          ];
          const thead = document.createElement("thead");
          const trHead = document.createElement("tr");
          encabezados.forEach(h => {
            const th = document.createElement("th");
            th.textContent = h;
            th.style.borderBottom = "2px solid #06b6d4";
            th.style.padding = "6px";
            th.style.textAlign = "center";
            trHead.appendChild(th);
          });
          thead.appendChild(trHead);
          tabla.appendChild(thead);

          // Filas de intervalos
          const tbody = document.createElement("tbody");
          prueba.intervals_data.forEach(row => {
            const tr = document.createElement("tr");

            [
              row.No,
              row.Inicial.toFixed(5),
              row.Final.toFixed(5),
              row.frecuencia_obt,
              row.frecuencia_obt_acu,
              row.P_Obt.toFixed(3),
              row.frecuencia_esp_acu.toFixed(2),
              row.P_Esp_A.toFixed(2),
              row.Dif.toFixed(4)
            ].forEach(val => {
              const td = document.createElement("td");
              td.textContent = val;
              td.style.padding = "6px";
              td.style.borderBottom = "1px solid #1e293b";
              td.style.textAlign = "center";
              tr.appendChild(td);
            });

            tbody.appendChild(tr);
          });
          tabla.appendChild(tbody);

          // Resumen al final
          const tfoot = document.createElement("tfoot");
          [
            ["DMAX", prueba.statistics.max_difference.toFixed(5)],
            ["Crítico", prueba.statistics.critical_value.toFixed(5)],
            ["Decisión", prueba.decision]
          ].forEach(([label, val]) => {
            const tr = document.createElement("tr");

            const tdLabel = document.createElement("td");
            tdLabel.colSpan = 8;
            tdLabel.textContent = label;
            tdLabel.style.textAlign = "right";
            tdLabel.style.fontWeight = "bold";
            tdLabel.style.padding = "6px";
            tdLabel.style.borderTop = "2px solid #06b6d4";

            const tdVal = document.createElement("td");
            tdVal.textContent = val;
            tdVal.style.textAlign = "center";
            tdVal.style.fontWeight = "bold";
            tdVal.style.padding = "6px";
            tdVal.style.borderTop = "2px solid #06b6d4";

            tr.appendChild(tdLabel);
            tr.appendChild(tdVal);
            tfoot.appendChild(tr);
          });
          tabla.appendChild(tfoot);

          stats.appendChild(tabla);
        } else if (prueba.test_name === "Prueba de Poker") {
          // Crear tabla
          const tabla = document.createElement("table");
          tabla.style.width = "100%";
          tabla.style.marginTop = "15px";
          tabla.style.borderCollapse = "collapse";
          tabla.style.fontFamily = "'Roboto Mono', monospace";
          tabla.style.fontSize = "13px";
          tabla.style.color = "#e2e8f0";

          // Encabezados
          const encabezados = ["Cat", "Oi", "Prob", "Ei", "(Oi-Ei)²/Ei"];
          const thead = document.createElement("thead");
          const trHead = document.createElement("tr");
          encabezados.forEach(h => {
            const th = document.createElement("th");
            th.textContent = h;
            th.style.borderBottom = "2px solid #06b6d4";
            th.style.padding = "6px";
            th.style.textAlign = "center";
            trHead.appendChild(th);
          });
          thead.appendChild(trHead);
          tabla.appendChild(thead);

          // Filas con los datos
          const tbody = document.createElement("tbody");
          prueba.intervals_data.forEach(row => {
            const tr = document.createElement("tr");

            [
              row.Cat,
              row.Oi,
              row.Prob.toFixed(4),
              row.Ei.toFixed(2),
              row["(Oi-Ei)^2/Ei"].toFixed(5)
            ].forEach(val => {
              const td = document.createElement("td");
              td.textContent = val;
              td.style.padding = "6px";
              td.style.borderBottom = "1px solid #1e293b";
              td.style.textAlign = "center";
              tr.appendChild(td);
            });

            tbody.appendChild(tr);
          });
          tabla.appendChild(tbody);

          card.appendChild(tabla);

          // Estadísticas adicionales
          stats.innerHTML = `
    <div class="stat-item"><strong>Suma Oi:</strong> ${prueba.statistics.Suma_Oi}</div>
    <div class="stat-item"><strong>χ² calculado:</strong> ${prueba.statistics.Chi2_calculado.toFixed(5)}</div>
    <div class="stat-item"><strong>χ² crítico:</strong> ${prueba.statistics.critical_value.toFixed(5)}</div>
    <div class="stat-item"><strong>Resultado:</strong> ${prueba.decision}</div>
  `;
        } else if (prueba.test_name === "Prueba de Varianza") {
          stats.innerHTML = `
          
          <div class="stat-item"><strong>n:</strong> ${prueba.n}</div>  
          <div class="stat-item"><strong>media_muestral:</strong> ${prueba.media_muestral.toFixed(5)}</div> 
          <div class="stat-item"><strong>Varianza muestral (s²):</strong> ${prueba.varianza_muestral.toFixed(5)}</div>
          <div class="stat-item"><strong>alpha/2:</strong> ${prueba.alphaDiv2}</div>
          <div class="stat-item"><strong>Z:</strong> ${prueba.z}</div>
          <div class="stat-item"><strong>Intervalo de confianza:</strong> [${prueba.Xi1.toFixed(5)}, ${prueba.Xi2.toFixed(5)}]</div>    
          `

        } else if (prueba.test_name === "Prueba Chi-Cuadrado") {
          stats.innerHTML = ""; // limpiar contenido anterior

          const tabla = document.createElement("table");
          tabla.style.width = "100%";
          tabla.style.borderCollapse = "collapse";
          tabla.style.marginTop = "10px";
          tabla.style.fontFamily = "'Roboto Mono', monospace";
          tabla.style.fontSize = "13px";
          tabla.style.color = "#e2e8f0";

          // Encabezados
          const encabezados = ["No", "Inicial", "Final", "Frec.Obt", "Frec.Esp", "Chi²"];
          const thead = document.createElement("thead");
          const trHead = document.createElement("tr");
          encabezados.forEach(h => {
            const th = document.createElement("th");
            th.textContent = h;
            th.style.borderBottom = "2px solid #06b6d4";
            th.style.padding = "6px";
            th.style.textAlign = "center";
            trHead.appendChild(th);
          });
          thead.appendChild(trHead);
          tabla.appendChild(thead);

          // Filas con intervalos
          const tbody = document.createElement("tbody");
          prueba.intervals_data.forEach(row => {
            const tr = document.createElement("tr");

            [
              row.no,
              row.inicio.toFixed(5),
              row.fin.toFixed(5),
              row.frecuencia_obt,
              row.frecuencia_esp.toFixed(2),
              row.chi2.toFixed(5)
            ].forEach(val => {
              const td = document.createElement("td");
              td.textContent = val;
              td.style.padding = "6px";
              td.style.borderBottom = "1px solid #1e293b";
              td.style.textAlign = "center";
              tr.appendChild(td);
            });

            tbody.appendChild(tr);
          });
          tabla.appendChild(tbody);

          // Fila Totales
          const trTotal = document.createElement("tr");

          const tdLabel = document.createElement("td");
          tdLabel.colSpan = 3;
          tdLabel.textContent = "Total";
          tdLabel.style.fontWeight = "bold";
          tdLabel.style.textAlign = "center";
          tdLabel.style.padding = "6px";
          tdLabel.style.borderTop = "2px solid #06b6d4";

          const tdFrecObt = document.createElement("td");
          tdFrecObt.textContent = prueba.statistics.frecuencia_obt_total;
          tdFrecObt.style.fontWeight = "bold";
          tdFrecObt.style.textAlign = "center";
          tdFrecObt.style.borderTop = "2px solid #06b6d4";

          const tdFrecEsp = document.createElement("td");
          tdFrecEsp.textContent = prueba.statistics.frecuencia_esp_total;
          tdFrecEsp.style.fontWeight = "bold";
          tdFrecEsp.style.textAlign = "center";
          tdFrecEsp.style.borderTop = "2px solid #06b6d4";

          const tdChi2 = document.createElement("td");
          tdChi2.textContent = prueba.statistics.chi2_total.toFixed(3);
          tdChi2.style.fontWeight = "bold";
          tdChi2.style.textAlign = "center";
          tdChi2.style.borderTop = "2px solid #06b6d4";

          trTotal.appendChild(tdLabel);
          trTotal.appendChild(tdFrecObt);
          trTotal.appendChild(tdFrecEsp);
          trTotal.appendChild(tdChi2);
          tabla.appendChild(trTotal);

          // Insertar tabla en el stats-info
          stats.appendChild(tabla);

          // Resumen debajo
          const resumen = document.createElement("div");
          resumen.style.marginTop = "10px";
          resumen.style.fontSize = "14px";
          resumen.innerHTML = `
    <strong>χ² crítico:</strong> ${prueba.statistics.chi2_critico.toFixed(5)}<br>
    <strong>Decisión:</strong> ${prueba.decision}
  `;
          stats.appendChild(resumen);
        } else if (prueba.test_name === "Prueba de Rachas") {
          stats.innerHTML = `
    <div class="stat-item"><strong>Mediana muestral:</strong> ${prueba.Mediana_muestral}</div>
    <div class="stat-item"><strong>Mediana teórica:</strong> ${prueba.Mediana_teorica}</div>
    
    <div class="stat-item"><strong>Rachas observadas:</strong> ${prueba.Rachas}</div>
    <div class="stat-item"><strong>Total "+" :</strong> ${prueba.Total_may}</div>
    <div class="stat-item"><strong>Total "-" :</strong> ${prueba.Total_min}</div>
    <div class="stat-item"><strong>Total:</strong> ${prueba.Total}</div>
    
    <div class="stat-item"><strong>UR (esperado):</strong> ${prueba.UR.toFixed(5)}</div>
    <div class="stat-item"><strong>Varianza:</strong> ${prueba.Varianza.toFixed(5)}</div>
    <div class="stat-item"><strong>Z:</strong> ${prueba.Z.toFixed(5)}</div>
    <div class="stat-item"><strong>Rango crítico (95%):</strong> [${prueba.Rango_min.toFixed(5)}, ${prueba.Rango_max.toFixed(5)}]</div>
  `;
        }



        card.appendChild(stats);

        const btnExportar = document.createElement("button");
        btnExportar.className = "export-btn";
        btnExportar.textContent = "📊 Exportar PNG";
        btnExportar.onclick = () => exportarImagen(canvas, prueba.test_name);
        card.appendChild(btnExportar);

        contenedor.appendChild(card);

        // Generar el gráfico
        const configuracion = obtenerConfiguracionGrafico(prueba);
        if (configuracion) {
          const chart = new Chart(canvas, configuracion);
          charts.push(chart);
        }
      });
    }

    function exportarImagen(canvas, nombrePrueba) {
      const link = document.createElement("a");
      link.download = `${nombrePrueba.replace(/\s+/g, "_")}_hibrido.png`;
      link.href = canvas.toDataURL("image/png", 1.0);
      link.click();
    }

    // CSS adicional que deberías agregar a tu hoja de estilos
    const estilosAdicionales = `
.stats-info {
  margin-top: 15px;
  padding: 15px;
  background: rgba(55, 65, 81, 0.3);
  border-radius: 8px;
  border-left: 4px solid #06b6d4;
}

.stat-item {
  margin: 8px 0;
  color: #d1d5db;
  font-size: 14px;
}

.stat-item strong {
  color: #06b6d4;
}

.chart-container {
  position: relative;
  margin: 20px 0;
}

.export-btn {
  background: linear-gradient(135deg, #06b6d4, #0891b2);
  border: none;
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
  margin-top: 15px;
}

.export-btn:hover {
  background: linear-gradient(135deg, #0891b2, #0e7490);
  transform: translateY(-2px);
}
`;
  </script>
</body>

</html>